name: Minimal Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Get version
      id: version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Build all platforms
      run: |
        # Build for all platforms
        LDFLAGS="-s -w -X main.Version=${{ steps.version.outputs.version }} -X main.BuildTime=$(date -u '+%Y-%m-%d_%H:%M:%S')"
        
        # Windows
        GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="$LDFLAGS" -o ytb2bili-windows-amd64.exe .
        
        # Linux
        GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="$LDFLAGS" -o ytb2bili-linux-amd64 .
        GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags="$LDFLAGS" -o ytb2bili-linux-arm64 .
        
        # macOS
        GOOS=darwin GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="$LDFLAGS" -o ytb2bili-darwin-amd64 .
        GOOS=darwin GOARCH=arm64 CGO_ENABLED=0 go build -ldflags="$LDFLAGS" -o ytb2bili-darwin-arm64 .

    - name: Create packages
      run: |
        # Create directories
        mkdir -p packages
        
        # Copy config template
        cp config.toml.example config.toml
        
        # Windows package
        mkdir -p win64
        cp ytb2bili-windows-amd64.exe win64/
        cp config.toml win64/
        cp README.md win64/
        cat > win64/start.bat << 'EOF'
        @echo off
        echo Starting YTB2BILI Server...
        ytb2bili-windows-amd64.exe
        pause
        EOF
        cd win64 && zip -r ../packages/ytb2bili-windows-amd64.zip . && cd ..
        
        # Linux amd64 package
        mkdir -p linux64
        cp ytb2bili-linux-amd64 linux64/
        cp config.toml linux64/
        cp README.md linux64/
        cat > linux64/start.sh << 'EOF'
        #!/bin/bash
        echo "Starting YTB2BILI Server..."
        chmod +x ./ytb2bili-linux-amd64
        ./ytb2bili-linux-amd64
        EOF
        chmod +x linux64/start.sh
        tar -czf packages/ytb2bili-linux-amd64.tar.gz -C linux64 .
        
        # Linux ARM64 package
        mkdir -p linux-arm64
        cp ytb2bili-linux-arm64 linux-arm64/
        cp config.toml linux-arm64/
        cp README.md linux-arm64/
        cat > linux-arm64/start.sh << 'EOF'
        #!/bin/bash
        echo "Starting YTB2BILI Server..."
        chmod +x ./ytb2bili-linux-arm64
        ./ytb2bili-linux-arm64
        EOF
        chmod +x linux-arm64/start.sh
        tar -czf packages/ytb2bili-linux-arm64.tar.gz -C linux-arm64 .
        
        # macOS Intel package
        mkdir -p macos-intel
        cp ytb2bili-darwin-amd64 macos-intel/
        cp config.toml macos-intel/
        cp README.md macos-intel/
        cat > macos-intel/start.sh << 'EOF'
        #!/bin/bash
        echo "Starting YTB2BILI Server..."
        chmod +x ./ytb2bili-darwin-amd64
        ./ytb2bili-darwin-amd64
        EOF
        chmod +x macos-intel/start.sh
        tar -czf packages/ytb2bili-darwin-amd64.tar.gz -C macos-intel .
        
        # macOS Apple Silicon package
        mkdir -p macos-arm64
        cp ytb2bili-darwin-arm64 macos-arm64/
        cp config.toml macos-arm64/
        cp README.md macos-arm64/
        cat > macos-arm64/start.sh << 'EOF'
        #!/bin/bash
        echo "Starting YTB2BILI Server..."
        chmod +x ./ytb2bili-darwin-arm64
        ./ytb2bili-darwin-arm64
        EOF
        chmod +x macos-arm64/start.sh
        tar -czf packages/ytb2bili-darwin-arm64.tar.gz -C macos-arm64 .
        
        # List packages
        ls -la packages/

    - name: Generate changelog
      run: |
        cat > CHANGELOG.md << EOF
        ## ðŸŽ‰ YTB2BILI Release ${{ steps.version.outputs.version }}
        
        ### ðŸ“¦ ä¸‹è½½é“¾æŽ¥
        
        | å¹³å° | æž¶æž„ | ä¸‹è½½ | å¤§å° |
        |------|------|------|------|
        | ðŸªŸ Windows | x64 | [ytb2bili-windows-amd64.zip](https://github.com/difyz9/ytb2bili/releases/download/${{ steps.version.outputs.version }}/ytb2bili-windows-amd64.zip) | $(du -h packages/ytb2bili-windows-amd64.zip | cut -f1) |
        | ðŸ§ Linux | x64 | [ytb2bili-linux-amd64.tar.gz](https://github.com/difyz9/ytb2bili/releases/download/${{ steps.version.outputs.version }}/ytb2bili-linux-amd64.tar.gz) | $(du -h packages/ytb2bili-linux-amd64.tar.gz | cut -f1) |
        | ðŸ§ Linux | ARM64 | [ytb2bili-linux-arm64.tar.gz](https://github.com/difyz9/ytb2bili/releases/download/${{ steps.version.outputs.version }}/ytb2bili-linux-arm64.tar.gz) | $(du -h packages/ytb2bili-linux-arm64.tar.gz | cut -f1) |
        | ðŸŽ macOS | Intel | [ytb2bili-darwin-amd64.tar.gz](https://github.com/difyz9/ytb2bili/releases/download/${{ steps.version.outputs.version }}/ytb2bili-darwin-amd64.tar.gz) | $(du -h packages/ytb2bili-darwin-amd64.tar.gz | cut -f1) |
        | ðŸŽ macOS | Apple Silicon | [ytb2bili-darwin-arm64.tar.gz](https://github.com/difyz9/ytb2bili/releases/download/${{ steps.version.outputs.version }}/ytb2bili-darwin-arm64.tar.gz) | $(du -h packages/ytb2bili-darwin-arm64.tar.gz | cut -f1) |
        
        ### ðŸš€ å¿«é€Ÿå¼€å§‹
        
        1. **ä¸‹è½½** å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…
        2. **è§£åŽ‹** åˆ°ä»»æ„ç›®å½•
        3. **é…ç½®** ç¼–è¾‘ \`config.toml\` æ–‡ä»¶
        4. **å¯åŠ¨** è¿è¡Œ \`start.sh\` æˆ– \`start.bat\`
        5. **è®¿é—®** http://localhost:8096
        
        ### âœ¨ åŠŸèƒ½ç‰¹æ€§
        
        - ðŸŽ¬ YouTube è§†é¢‘è‡ªåŠ¨ä¸‹è½½
        - ðŸŽ¤ AI è‡ªåŠ¨ç”Ÿæˆå­—å¹• (Whisper)
        - ðŸŒ æ™ºèƒ½å­—å¹•ç¿»è¯‘ (ç™¾åº¦/DeepSeek)
        - ðŸ¤– AI ç”Ÿæˆè§†é¢‘å…ƒæ•°æ®
        - ðŸ“º è‡ªåŠ¨ä¸Šä¼ åˆ° Bilibili
        - â° æ™ºèƒ½å®šæ—¶è°ƒåº¦ä¸Šä¼ 
        
        ### ðŸ› ï¸ ç³»ç»Ÿè¦æ±‚
        
        - **å†…å­˜**: å»ºè®® 4GB+ (ç”¨äºŽè§†é¢‘å¤„ç†)
        - **å­˜å‚¨**: å»ºè®® 10GB+ (ç”¨äºŽè§†é¢‘ç¼“å­˜)
        - **ç½‘ç»œ**: ç¨³å®šçš„äº’è”ç½‘è¿žæŽ¥
        
        ### ðŸ†˜ èŽ·å–å¸®åŠ©
        
        - ðŸ“– [å®Œæ•´æ–‡æ¡£](https://github.com/difyz9/ytb2bili/blob/main/README.md)
        - ðŸ› [é—®é¢˜åé¦ˆ](https://github.com/difyz9/ytb2bili/issues)
        - ðŸ’¬ QQäº¤æµç¾¤: **773066052**
        
        ---
        **æž„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S') UTC  
        **Goç‰ˆæœ¬**: $(go version)
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: Release ${{ steps.version.outputs.version }}
        body_path: CHANGELOG.md
        files: packages/*
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}